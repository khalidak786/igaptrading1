<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGAP | KYC Workflow</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF CDN for client-side PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 700px; /* Increased max-width for more fields */
            text-align: center;
            position: relative;
            overflow: hidden; /* For smooth transitions */
        }
        .form-section {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transform: translateX(100%);
        }
        .form-section.active {
            opacity: 1;
            transform: translateX(0);
            position: relative; /* Make active section take up space */
        }
        .form-section.hidden {
            display: none;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 15px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .legal-text-container {
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            padding-right: 15px; /* For scrollbar */
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
            padding: 20px;
        }
        .legal-text-container h2, .legal-text-container h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        .legal-text-container p, .legal-text-container ul, .legal-text-container ol {
            margin-bottom: 1rem;
            color: #4b5563;
            line-height: 1.6;
        }
        .legal-text-container ul {
            list-style-type: disc;
            margin-left: 20px;
        }
        .legal-text-container ol {
            list-style-type: decimal;
            margin-left: 20px;
        }
        .legal-text-container li {
            margin-bottom: 0.5rem;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than loading overlay */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
        </div>

        <!-- Login Form Section -->
        <div id="loginSection" class="form-section active">
            <!-- IGAP Logo SVG -->
            <svg width="150" height="50" viewBox="0 0 150 50" class="mb-8 mx-auto">
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                      font-family="Inter, sans-serif" font-size="36" font-weight="700" fill="#60A5FA">
                    IGAP
                </text>
            </svg>
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Login to KYC Portal</h2>
            <p class="text-sm text-gray-600 mb-4">
                Your User ID: <span id="userIdDisplay" class="font-semibold text-blue-600">Loading...</span>
            </p>
            <form id="loginForm" class="w-full max-w-sm">
                <div class="mb-4">
                    <input type="email" id="email" placeholder="Email" required autocomplete="username"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="mb-6">
                    <input type="password" id="password" placeholder="Password" required autocomplete="current-password"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md">
                    Login
                </button>
                <p id="loginError" class="text-red-500 text-sm mt-4 hidden"></p>
            </form>
        </div>

        <!-- Terms & Conditions / Disclaimer Section -->
        <div id="termsSection" class="form-section hidden">
            <!-- IGAP Logo SVG -->
            <svg width="150" height="50" viewBox="0 0 150 50" class="mb-8 mx-auto">
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                      font-family="Inter, sans-serif" font-size="36" font-weight="700" fill="#60A5FA">
                    IGAP
                </text>
            </svg>
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Terms & Conditions and Disclaimer</h2>
            <div class="legal-text-container">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Terms and Conditions of Information Submission</h3>
                <p>This document outlines the terms and conditions ("Terms") governing the submission of information by you ("Client" or "You") to IGAP LLC Fz ("IGAP," "We," "Us," or "Our"), a company registered in Meydan Free Zone, Dubai, UAE. By proceeding with the submission of information through this online portal, You acknowledge and agree to be bound by these Terms.</p>
                <ol class="list-decimal list-inside ml-4 text-gray-600">
                    <li><strong>Purpose of Information Collection (KYC):</strong> The information requested and submitted by You through this portal is solely for the purpose of IGAP conducting its internal Know Your Customer (KYC), anti-money laundering (AML), and compliance checks. This process is undertaken to facilitate the potential onboarding of You as a client for commodity trading activities.</li>
                    <li><strong>Confidentiality and Data Usage:</strong> IGAP undertakes to treat all information submitted by You with reasonable confidentiality. However, You acknowledge that IGAP may share this information with its internal compliance, legal, and risk departments, and with external regulatory bodies or third-party service providers, as required by law or necessary for the aforementioned AML and compliance checks.</li>
                    <li><strong>Accuracy of Information:</strong> You warrant that all information provided by You is true, accurate, complete, and not misleading in any material respect. You agree to promptly update any information that becomes inaccurate or outdated.</li>
                    <li><strong>Non-Binding Nature:</strong> The submission of information through this portal, and IGAP's review thereof, does not constitute an offer, acceptance, or commitment by either party to enter into any business relationship, contract, or agreement whatsoever. This process is purely for preliminary assessment and due diligence.</li>
                    <li><strong>No Obligation to Onboard:</strong> IGAP reserves the absolute right, at its sole discretion, to accept or reject any potential client without providing any reason. The submission of information does not create any expectation or entitlement for You to be onboarded as a client.</li>
                    <li><strong>Intellectual Property:</strong> All content, design, and functionality of this online portal are the exclusive property of IGAP LLC Fz.</li>
                    <li><strong>Governing Law and Jurisdiction:</strong> These Terms shall be governed by and construed in accordance with the laws of the Dubai International Financial Centre (DIFC), without regard to its conflict of law principles. Any dispute arising out of or in connection with these Terms shall be subject to the exclusive jurisdiction of the DIFC Courts.</li>
                </ol>

                <h3 class="text-xl font-semibold text-gray-700 mb-2">Disclaimer</h3>
                <p>By proceeding, You acknowledge and agree to the following disclaimer:</p>
                <ol class="list-decimal list-inside ml-4 text-gray-600">
                    <li><strong>No Liability:</strong> IGAP LLC Fz, its owners, shareholders, directors, officers, employees, agents, and affiliates (collectively, "IGAP Parties") shall not be liable for any direct, indirect, incidental, consequential, special, punitive, or exemplary damages, including but not limited to, damages for loss of profits, goodwill, data, or other intangible losses, resulting from:
                        <ul class="list-disc list-inside ml-4">
                            <li>The use or inability to use this online portal or the information submitted.</li>
                            <li>Any actions taken or not taken based on the information provided or the outcome of the compliance checks.</li>
                            <li>Any errors or omissions in the information provided by You.</li>
                            <li>Any unauthorized access to or alteration of Your transmissions or data.</li>
                            <li>Any other matter relating to this information submission process.</li>
                        </ul>
                    </li>
                    <li><strong>No Representations or Warranties:</strong> This online portal and the information submission process are provided on an "as is" and "as available" basis, without any representations or warranties of any kind, express or implied, including but not limited to, implied warranties of merchantability, fitness for a particular purpose, or non-infringement.</li>
                    <li><strong>Independent Legal Advice:</strong> You are strongly advised to seek independent legal advice regarding these Terms and the implications of submitting Your information to IGAP.</li>
                    <li><strong>Acceptance:</strong> Your act of clicking "I Accept" or proceeding with the information submission signifies Your full understanding and unconditional acceptance of these Terms and Disclaimer.</li>
                </ol>
            </div>
            <button id="acceptTermsBtn"
                    class="w-auto px-8 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 shadow-md mx-auto">
                I Accept
            </button>
        </div>

        <!-- KYC Form Section -->
        <div id="kycFormSection" class="form-section hidden">
            <!-- IGAP Logo SVG -->
            <svg width="150" height="50" viewBox="0 0 150 50" class="mb-8 mx-auto">
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                      font-family="Inter, sans-serif" font-size="36" font-weight="700" fill="#60A5FA">
                    IGAP
                </text>
            </svg>
            <h2 class="text-3xl font-bold text-gray-800 mb-6">KYC Application Form</h2>
            <form id="kycForm" class="w-full max-w-xl text-left">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="companyName" class="block text-gray-700 text-sm font-bold mb-2">Company Name:</label>
                        <input type="text" id="companyName" placeholder="Enter company name" required autocomplete="organization"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="legalEntityType" class="block text-gray-700 text-sm font-bold mb-2">Legal Entity Type:</label>
                        <select id="legalEntityType"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                            <option value="">Select Type</option>
                            <option value="Corporation">Corporation</option>
                            <option value="Partnership">Partnership</option>
                            <option value="LLC">LLC (Limited Liability Company)</option>
                            <option value="Sole Proprietorship">Sole Proprietorship</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="regNumber" class="block text-gray-700 text-sm font-bold mb-2">Registration Number:</label>
                        <input type="text" id="regNumber" placeholder="Enter registration number" autocomplete="off"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="dateOfIncorporation" class="block text-gray-700 text-sm font-bold mb-2">Date of Incorporation:</label>
                        <input type="date" id="dateOfIncorporation" autocomplete="off"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="placeOfIncorporation" class="block text-gray-700 text-sm font-bold mb-2">Place of Incorporation:</label>
                        <input type="text" id="placeOfIncorporation" placeholder="e.g., Dubai, UAE" autocomplete="address-level2"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="taxIdNumber" class="block text-gray-700 text-sm font-bold mb-2">Tax Identification Number (TIN):</label>
                        <input type="text" id="taxIdNumber" placeholder="Enter TIN" autocomplete="taxid"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="companyAddress" class="block text-gray-700 text-sm font-bold mb-2">Company Address:</label>
                    <textarea id="companyAddress" placeholder="Enter full company address" rows="3" autocomplete="street-address"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"></textarea>
                </div>

                <div class="mb-4">
                    <label for="websiteUrl" class="block text-gray-700 text-sm font-bold mb-2">Company Website (Optional):</label>
                    <input type="url" id="websiteUrl" placeholder="https://www.example.com" autocomplete="url"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>

                <div class="mb-4">
                    <label for="businessDescription" class="block text-gray-700 text-sm font-bold mb-2">Detailed Business Activities:</label>
                    <textarea id="businessDescription" placeholder="Describe your primary business activities in detail" rows="4"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="commoditiesTraded" class="block text-gray-700 text-sm font-bold mb-2">Types of Commodities Traded:</label>
                        <input type="text" id="commoditiesTraded" placeholder="e.g., Crude Oil, Gold, Wheat (comma-separated)"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="tonnageTraded" class="block text-gray-700 text-sm font-bold mb-2">Tonnage of Commodity Traded (Last 3 Years, in Metric Tons):</label>
                        <input type="number" id="tonnageTraded" placeholder="e.g., 100000" min="0"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="annualTurnover" class="block text-gray-700 text-sm font-bold mb-2">Estimated Annual Turnover (USD):</label>
                        <input type="number" id="annualTurnover" placeholder="e.g., 5000000" min="0"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="countriesOfOperation" class="block text-gray-700 text-sm font-bold mb-2">Primary Countries of Operation:</label>
                        <input type="text" id="countriesOfOperation" placeholder="e.g., UAE, India, Singapore (comma-separated)"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Compliance Details</h3>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Do you or your company deal with any sanctioned entity, country, individual, vessel, or any related party which is sanctioned by any international or national authority?
                    </label>
                    <div class="flex items-center space-x-4 mt-2">
                        <input type="radio" id="sanctionedYes" name="sanctionedDealing" value="Yes"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                        <label for="sanctionedYes" class="text-gray-700">Yes</label>

                        <input type="radio" id="sanctionedNo" name="sanctionedDealing" value="No"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                        <label for="sanctionedNo" class="text-gray-700">No</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Is your entity part of a group?
                    </label>
                    <div class="flex items-center space-x-4 mt-2">
                        <input type="radio" id="groupYes" name="isGroup" value="Yes"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                        <label for="groupYes" class="text-gray-700">Yes</label>

                        <input type="radio" id="groupNo" name="isGroup" value="No"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                        <label for="groupNo" class="text-gray-700">No</label>
                    </div>
                </div>

                <div id="groupDetails" class="hidden">
                    <div class="mb-4">
                        <label for="groupName" class="block text-gray-700 text-sm font-bold mb-2">Group Name:</label>
                        <input type="text" id="groupName" placeholder="Enter group name"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div class="mb-4">
                        <label for="otherRelatedEntities" class="block text-gray-700 text-sm font-bold mb-2">Other Related Entities (if any, comma-separated):</label>
                        <textarea id="otherRelatedEntities" placeholder="e.g., Subsidiary A, Parent Company B" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"></textarea>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Key Position Holders</h3>
                <div class="mb-4 border p-4 rounded-lg bg-gray-50">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">CEO Details:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="ceoName" class="block text-gray-700 text-sm font-bold mb-2">Full Name:</label>
                            <input type="text" id="ceoName" placeholder="CEO's Full Name" autocomplete="name"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label for="ceoEmail" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="ceoEmail" placeholder="CEO's Email" autocomplete="email"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="ceoPhone" class="block text-gray-700 text-sm font-bold mb-2">Phone Number (Optional):</label>
                        <input type="tel" id="ceoPhone" placeholder="CEO's Phone Number" autocomplete="tel"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <div class="mb-4 border p-4 rounded-lg bg-gray-50">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">CFO Details:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="cfoName" class="block text-gray-700 text-sm font-bold mb-2">Full Name:</label>
                            <input type="text" id="cfoName" placeholder="CFO's Full Name" autocomplete="name"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label for="cfoEmail" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="cfoEmail" placeholder="CFO's Email" autocomplete="email"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="cfoPhone" class="block text-gray-700 text-sm font-bold mb-2">Phone Number (Optional):</label>
                        <input type="tel" id="cfoPhone" placeholder="CFO's Phone Number" autocomplete="tel"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Other Key Position Holder (Optional):</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="otherKeyName" class="block text-gray-700 text-sm font-bold mb-2">Full Name:</label>
                            <input type="text" id="otherKeyName" placeholder="Name"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label for="otherKeyPosition" class="block text-gray-700 text-sm font-bold mb-2">Position/Title:</label>
                            <input type="text" id="otherKeyPosition" placeholder="Position"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                        <div>
                            <label for="otherKeyEmail" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="otherKeyEmail" placeholder="Email"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label for="otherKeyPhone" class="block text-gray-700 text-sm font-bold mb-2">Phone Number:</label>
                            <input type="tel" id="otherKeyPhone" placeholder="Phone Number"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Contact Person Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="contactPerson" class="block text-gray-700 text-sm font-bold mb-2">Full Name:</label>
                        <input type="text" id="contactPerson" placeholder="Enter contact person's full name"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="contactPersonPosition" class="block text-gray-700 text-sm font-bold mb-2">Position/Title:</label>
                        <input type="text" id="contactPersonPosition" placeholder="e.g., CEO, Head of Compliance"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="contactEmail" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="contactEmail" placeholder="Enter contact email" required autocomplete="email"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="contactPhone" class="block text-gray-700 text-sm font-bold mb-2">Phone Number:</label>
                        <input type="tel" id="contactPhone" placeholder="e.g., +971 50 123 4567" required autocomplete="tel"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Bank Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="bankName" class="block text-gray-700 text-sm font-bold mb-2">Bank Name:</label>
                        <input type="text" id="bankName" placeholder="Enter bank name" autocomplete="off"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="bankAccountNumber" class="block text-gray-700 text-sm font-bold mb-2">Bank Account Number:</label>
                        <input type="text" id="bankAccountNumber" placeholder="Enter account number" autocomplete="off"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                </div>
                <div class="mb-6">
                    <label for="swiftBic" class="block text-gray-700 text-sm font-bold mb-2">SWIFT/BIC Code:</label>
                    <input type="text" id="swiftBic" placeholder="Enter SWIFT/BIC code" autocomplete="off"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Supporting Documents</h3>
                <div class="mb-4">
                    <label for="regCertificateFile" class="block text-gray-700 text-sm font-bold mb-2">Company Registration Certificate (PDF):</label>
                    <input type="file" id="regCertificateFile" accept=".pdf"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="taxIdFile" class="block text-gray-700 text-sm font-bold mb-2">Tax Identification Document (PDF):</label>
                    <input type="file" id="taxIdFile" accept=".pdf"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="bankStatementFile" class="block text-gray-700 text-sm font-bold mb-2">Recent Bank Statement (PDF):</label>
                    <input type="file" id="bankStatementFile" accept=".pdf"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="orgChartFile" class="block text-gray-700 text-sm font-bold mb-2">Organization Chart (PDF):</label>
                    <input type="file" id="orgChartFile" accept=".pdf"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="otherDocsFile" class="block text-gray-700 text-sm font-bold mb-2">Other Supporting Documents (PDF, multiple allowed):</label>
                    <input type="file" id="otherDocsFile" accept=".pdf" multiple
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>

                <div class="mb-6 flex items-start">
                    <input type="checkbox" id="complianceUndertaking" class="mr-2 mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="complianceUndertaking" class="text-gray-700 text-sm text-left">
                        I hereby undertake and confirm that our entity complies with all applicable laws, regulations, and governmental orders related to our business operations, including but not limited to, environmental, labor, financial, and trade regulations, in all jurisdictions where we operate.
                    </label>
                </div>

                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="dataAccuracyConsent" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="dataAccuracyConsent" class="text-gray-700 text-sm">I confirm that all information provided is accurate and complete to the best of my knowledge.</label>
                </div>

                <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md mb-4">
                    Submit KYC Application
                </button>
                <p id="kycSuccess" class="text-green-500 text-sm mt-4 hidden"></p>
                <p id="kycError" class="text-red-500 text-sm mt-4 hidden"></p>
                <button id="logoutBtn"
                        class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 shadow-md">
                    Logout
                </button>
            </form>
        </div>
    </div>

    <!-- Success Modal Structure -->
    <div id="successModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Submission Successful!</h3>
            <p id="modalMessage" class="text-gray-700 mb-6">Thank you for submitting KYC details, we will review the details and contact you.</p>
            <button id="modalOkBtn"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md">
                OK
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Destructure jsPDF from the global window object (loaded via CDN)
        const { jsPDF } = window.jspdf;


        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Use the explicit firebaseConfig provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyC_FHvA4TPW3T0msOXji2uz7_mfkvX0-UA",
            authDomain: "tester-a9f07.firebaseapp.com",
            projectId: "tester-a9f07",
            storageBucket: "tester-a9f07.firebasestorage.app",
            messagingSenderId: "840050053279",
            appId: "1:840050053279:web:947b64c07f330af68452aa",
            measurementId: "G-3C5E3N06TT"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // Initialize Firebase Storage


        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const termsSection = document.getElementById('termsSection');
        const kycFormSection = document.getElementById('kycFormSection');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email'); // Added for clearing
        const passwordInput = document.getElementById('password'); // Added for clearing
        const acceptTermsBtn = document.getElementById('acceptTermsBtn');
        const kycForm = document.getElementById('kycForm');
        const loginError = document.getElementById('loginError');
        const kycSuccess = document.getElementById('kycSuccess'); // This will now be hidden, modal replaces its function
        const kycError = document.getElementById('kycError');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const logoutBtn = document.getElementById('logoutBtn');

        const groupYesRadio = document.getElementById('groupYes');
        const groupNoRadio = document.getElementById('groupNo');
        const groupDetailsDiv = document.getElementById('groupDetails');
        const groupNameInput = document.getElementById('groupName');
        const otherRelatedEntitiesTextarea = document.getElementById('otherRelatedEntities');

        // Key Position Holders
        const ceoNameInput = document.getElementById('ceoName');
        const ceoEmailInput = document.getElementById('ceoEmail');
        const ceoPhoneInput = document.getElementById('ceoPhone');
        const cfoNameInput = document.getElementById('cfoName');
        const cfoEmailInput = document.getElementById('cfoEmail'); // Corrected this line
        const cfoPhoneInput = document.getElementById('cfoPhone');
        const otherKeyNameInput = document.getElementById('otherKeyName');
        const otherKeyPositionInput = document.getElementById('otherKeyPosition');
        const otherKeyEmailInput = document.getElementById('otherKeyEmail');
        const otherKeyPhoneInput = document.getElementById('otherKeyPhone');

        // File inputs
        const regCertificateFile = document.getElementById('regCertificateFile');
        const taxIdFile = document.getElementById('taxIdFile');
        const bankStatementFile = document.getElementById('bankStatementFile');
        const orgChartFile = document.getElementById('orgChartFile');
        const otherDocsFile = document.getElementById('otherDocsFile');

        // Checkboxes
        const complianceUndertakingCheckbox = document.getElementById('complianceUndertaking');
        const dataAccuracyConsentCheckbox = document.getElementById('dataAccuracyConsent');

        // Modal elements
        const successModal = document.getElementById('successModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkBtn = document.getElementById('modalOkBtn');


        let currentUserId = null;

        // Function to show loading overlay
        function showLoading() {
            loadingOverlay.classList.add('visible');
        }

        // Function to hide loading overlay
        function hideLoading() {
            loadingOverlay.classList.remove('visible');
        }

        // Function to show custom modal
        function showSuccessModal(message) {
            modalMessage.textContent = message;
            successModal.classList.add('visible');
        }

        // Function to hide custom modal and reset form/navigate
        async function hideSuccessModal() {
            successModal.classList.remove('visible');
            kycForm.reset(); // Clear the form
            dataAccuracyConsentCheckbox.checked = false; // Manually reset checkbox
            complianceUndertakingCheckbox.checked = false; // Manually reset new checkbox
            document.getElementsByName('sanctionedDealing').forEach(radio => radio.checked = false); // Reset radio buttons
            document.getElementsByName('isGroup').forEach(radio => radio.checked = false); // Reset group radio buttons
            groupDetailsDiv.classList.add('hidden'); // Hide group details
            groupNameInput.removeAttribute('required');
            otherRelatedEntitiesTextarea.removeAttribute('required');

            // Clear file inputs
            regCertificateFile.value = '';
            taxIdFile.value = '';
            bankStatementFile.value = '';
            orgChartFile.value = '';
            otherDocsFile.value = '';

            // Log out the user after successful submission
            try {
                await signOut(auth);
                console.log("User logged out after KYC submission.");
            } catch (error) {
                console.error("Error logging out after KYC submission:", error);
            } finally {
                // Ensure login fields are cleared regardless of logout success
                emailInput.value = '';
                passwordInput.value = '';
                showSection(loginSection); // Go back to login screen
            }
        }

        // Function to switch sections with animation
        function showSection(sectionToShow) {
            const sections = [loginSection, termsSection, kycFormSection];
            sections.forEach(section => {
                if (section === sectionToShow) {
                    section.classList.remove('hidden');
                    setTimeout(() => section.classList.add('active'), 10); // Small delay for transition
                } else {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                }
            });
        }

        // Function to sanitize and validate input for vulgar words and risky characters
        // Returns true if valid, false otherwise. Sets kycError message.
        function sanitizeAndValidateInput(inputString, fieldName) {
            if (typeof inputString !== 'string' || inputString.trim() === '') {
                return true; // Let other required field validation handle empty strings
            }

            // List of vulgar words (case-insensitive) - extend as needed
            const vulgarWords = ['fuck', 'shit', 'asshole', 'bitch', 'cunt', 'damn', 'bastard', 'whore', 'porn', 'sex'];
            const lowerCaseInput = inputString.toLowerCase();

            for (const word of vulgarWords) {
                if (lowerCaseInput.includes(word)) {
                    kycError.textContent = `Input for "${fieldName}" contains inappropriate language. Please review.`;
                    kycError.classList.remove('hidden');
                    return false;
                }
            }

            // Regex to detect common risky HTML/script patterns for XSS
            // This is a basic client-side check. Server-side sanitization is crucial.
            const riskyHtmlPattern = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>|<iframe\b|<img\b[^>]*onerror\b|<a\b[^>]*javascript:|eval\(|document\.cookie|window\.location/i;
            if (riskyHtmlPattern.test(inputString)) {
                kycError.textContent = `Input for "${fieldName}" contains risky characters or patterns (e.g., HTML tags, script). Please remove them.`;
                kycError.classList.remove('hidden');
                return false;
            }

            // Basic check for common SQL injection patterns
            // This is a basic client-side check. Server-side validation is crucial.
            const sqlInjectionPattern = /(?:--|#|\/\*|\*\/|xp_cmdshell|exec|union all select|insert into|drop table|alter table|delete from|update set|select \* from|delete from)/i;
            if (sqlInjectionPattern.test(lowerCaseInput)) {
                kycError.textContent = `Input for "${fieldName}" contains potentially malicious patterns. Please review.`;
                kycError.classList.remove('hidden');
                return false;
            }

            return true; // Input is clean
        }


        // Authentication state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                console.log("User logged in:", user.uid);
                // If user is already logged in, show terms directly
                showSection(termsSection);
            } else {
                // User is signed out
                currentUserId = null;
                userIdDisplay.textContent = "Not logged in";
                emailInput.value = ''; // Clear email on logout
                passwordInput.value = ''; // Clear password on logout
                console.log("User logged out or not authenticated.");
                showSection(loginSection); // Show login if not authenticated
            }
            hideLoading(); // Hide loading once auth state is determined
        });

        // Initial authentication attempt (only custom token, no anonymous fallback)
        window.onload = async function() {
            showLoading();
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    // If no initialAuthToken, let onAuthStateChanged handle showing login.
                    console.log("No initial custom token, waiting for manual login.");
                    showSection(loginSection); // Ensure login section is shown
                }
            } catch (error) {
                console.error("Firebase initial sign-in error:", error);
                showSection(loginSection); // Ensure login section is shown on error
            } finally {
                // onAuthStateChanged will hide loading.
            }
        };

        // Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.classList.add('hidden'); // Hide previous errors

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle showing the terms section
            } catch (error) {
                let errorMessage = "An unknown error occurred. Please try again.";
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = "The email address is not valid.";
                        break;
                    case 'auth/user-disabled':
                        errorMessage = "This user account has been disabled.";
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Invalid email or password."; // Combine for security
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "Too many failed login attempts. Please try again later.";
                        break;
                    default:
                        errorMessage = error.message; // Fallback to Firebase's message
                }
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
                console.error("Login error:", error);
            } finally {
                hideLoading();
            }
        });

        // Accept Terms & Conditions
        acceptTermsBtn.addEventListener('click', () => {
            showSection(kycFormSection);
        });

        // Event listeners for group affiliation radios
        groupYesRadio.addEventListener('change', () => {
            if (groupYesRadio.checked) {
                groupDetailsDiv.classList.remove('hidden');
                // Group name and related entities are still conditionally required if 'Yes' is selected
                groupNameInput.setAttribute('required', 'true');
                otherRelatedEntitiesTextarea.setAttribute('required', 'true');
            }
        });

        groupNoRadio.addEventListener('change', () => {
            if (groupNoRadio.checked) {
                groupDetailsDiv.classList.add('hidden');
                groupNameInput.removeAttribute('required');
                otherRelatedEntitiesTextarea.removeAttribute('required');
                groupNameInput.value = ''; // Clear values when hidden
                otherRelatedEntitiesTextarea.value = ''; // Clear values when hidden
            }
        });

        // Event listener for modal OK button
        modalOkBtn.addEventListener('click', hideSuccessModal);

        /**
         * Uploads a file (or Blob) to Firebase Storage and returns its download URL.
         * @param {File|Blob} file The file or Blob to upload.
         * @param {string} fileName The name to give the file in storage.
         * @param {string} userId The current user's ID.
         * @param {string} kycDocId The Firestore document ID for the KYC application.
         * @returns {Promise<string|null>} A promise that resolves with the download URL or null if upload fails.
         */
        async function uploadFile(file, fileName, userId, kycDocId) {
            if (!file) return null;

            const storagePath = `kycigaptrading_attachments/${userId}/${kycDocId}/${fileName}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Observe state change events such as progress, pause, and resume
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log(`Upload of ${fileName} is ${progress}% done`);
                    },
                    (error) => {
                        console.error(`Error uploading ${fileName}:`, error);
                        reject(null);
                    },
                    async () => {
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            console.log(`File ${fileName} available at`, downloadURL);
                            resolve(downloadURL);
                        } catch (error) {
                            console.error(`Error getting download URL for ${fileName}:`, error);
                            reject(null);
                        }
                    }
                );
            });
        }

        /**
         * Generates a PDF from the KYC form data using jsPDF.
         * @param {Object} formData The collected form data.
         * @param {Object} uploadedFileUrls URLs of already uploaded files (to include in PDF).
         * @returns {Promise<Blob>} A promise that resolves with the generated PDF Blob.
         */
        async function generateKycPdf(formData, uploadedFileUrls) {
            const doc = new jsPDF();
            let y = 10; // Initial Y position for text
            const margin = 10;
            const lineHeight = 7;
            const sectionSpacing = 10;
            const fieldSpacing = 5;

            // Title
            doc.setFontSize(22);
            doc.text("KYC Application Summary", margin, y);
            y += sectionSpacing * 2;

            // Submission Info
            doc.setFontSize(10);
            doc.text(`Submission Date: ${new Date().toLocaleDateString()}`, margin, y);
            y += lineHeight;
            doc.text(`User ID: ${currentUserId || 'N/A'}`, margin, y);
            y += sectionSpacing;

            // Helper to add a section title
            const addSectionTitle = (title) => {
                if (y + sectionSpacing + lineHeight * 2 > doc.internal.pageSize.height - margin) {
                    doc.addPage();
                    y = margin;
                }
                doc.setFontSize(16);
                doc.text(title, margin, y);
                y += lineHeight + 3; // Space after title
                doc.setDrawColor(200); // Light gray line
                doc.line(margin, y, doc.internal.pageSize.width - margin, y); // Draw a line
                y += lineHeight; // Space after line
                doc.setFontSize(10); // Reset font size for content
            };

            // Helper to add text and manage page breaks for field-value pairs
            const addTextWithPageBreak = (label, value) => {
                const text = `${label}: ${value || 'N/A'}`;
                const splitText = doc.splitTextToSize(text, doc.internal.pageSize.width - margin * 2);
                
                // Check if content fits on current page, if not, add new page
                if (y + (splitText.length * lineHeight) > doc.internal.pageSize.height - margin) {
                    doc.addPage();
                    y = margin; // Reset Y for new page
                    // Optionally repeat section title on new page if it's a continuation
                }
                doc.text(splitText, margin, y);
                y += (splitText.length * lineHeight) + fieldSpacing; // Line height + spacing between fields
            };

            // Company Details
            addSectionTitle("Company Details");
            addTextWithPageBreak("Company Name", formData.companyName);
            addTextWithPageBreak("Legal Entity Type", formData.legalEntityType);
            addTextWithPageBreak("Registration Number", formData.regNumber);
            addTextWithPageBreak("Date of Incorporation", formData.dateOfIncorporation);
            addTextWithPageBreak("Place of Incorporation", formData.placeOfIncorporation);
            addTextWithPageBreak("Tax ID Number", formData.taxIdNumber);
            addTextWithPageBreak("Company Address", formData.companyAddress);
            addTextWithPageBreak("Website URL", formData.websiteUrl);
            addTextWithPageBreak("Business Description", formData.businessDescription);
            addTextWithPageBreak("Commodities Traded", formData.commoditiesTraded);
            addTextWithPageBreak("Tonnage Traded (Last 3 Years)", formData.tonnageTraded);
            addTextWithPageBreak("Annual Turnover (USD)", formData.annualTurnover);
            addTextWithPageBreak("Countries of Operation", formData.countriesOfOperation);
            y += sectionSpacing;

            // Compliance Details
            addSectionTitle("Compliance Details");
            addTextWithPageBreak("Deals with Sanctioned Entity", formData.sanctionedDealing);
            addTextWithPageBreak("Part of a Group", formData.isGroup);
            if (formData.isGroup === 'Yes') {
                addTextWithPageBreak("Group Name", formData.groupName);
                addTextWithPageBreak("Other Related Entities", formData.otherRelatedEntities);
            }
            y += sectionSpacing;

            // Key Position Holders
            addSectionTitle("Key Position Holders");
            addTextWithPageBreak("CEO Name", formData.ceoName);
            addTextWithPageBreak("CEO Email", formData.ceoEmail);
            addTextWithPageBreak("CEO Phone", formData.ceoPhone);
            addTextWithPageBreak("CFO Name", formData.cfoName);
            addTextWithPageBreak("CFO Email", formData.cfoEmail);
            addTextWithPageBreak("CFO Phone", formData.cfoPhone);
            addTextWithPageBreak("Other Key Name", formData.otherKeyName);
            addTextWithPageBreak("Other Key Position", formData.otherKeyPosition);
            addTextWithPageBreak("Other Key Email", formData.otherKeyEmail);
            addTextWithPageBreak("Other Key Phone", formData.otherKeyPhone);
            addTextWithPageBreak("Contact Person Name", formData.contactPerson);
            addTextWithPageBreak("Contact Person Position", formData.contactPersonPosition);
            addTextWithPageBreak("Contact Email", formData.contactEmail);
            addTextWithPageBreak("Contact Phone", formData.contactPhone);
            y += sectionSpacing;

            // Bank Details
            addSectionTitle("Bank Details");
            addTextWithPageBreak("Bank Name", formData.bankName);
            addTextWithPageBreak("Bank Account Number", formData.bankAccountNumber);
            addTextWithPageBreak("SWIFT/BIC Code", formData.swiftBic);
            y += sectionSpacing;

            // Declarations
            addSectionTitle("Declarations");
            addTextWithPageBreak("Compliance Undertaking Agreed", formData.complianceUndertaking ? 'Yes' : 'No');
            addTextWithPageBreak("Data Accuracy Consent Agreed", formData.dataAccuracyConsent ? 'Yes' : 'No');
            y += sectionSpacing;

            // Uploaded Attachments
            addSectionTitle("Uploaded Attachments");
            const attachmentKeys = Object.keys(uploadedFileUrls);
            if (attachmentKeys.length > 0) {
                attachmentKeys.forEach(key => {
                    const url = uploadedFileUrls[key];
                    if (Array.isArray(url)) { // For 'otherDocs' which can be multiple URLs
                        url.forEach((individualUrl, index) => {
                            addTextWithPageBreak(`- ${key} (${index + 1})`, individualUrl);
                        });
                    } else {
                        addTextWithPageBreak(`- ${key}`, url);
                    }
                });
            } else {
                addTextWithPageBreak("No additional attachments uploaded.", "");
            }
            y += sectionSpacing;

            return doc.output('blob'); // Return as Blob
        }


        // KYC Form Submission
        kycForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            kycError.classList.add('hidden'); // Clear previous errors

            if (!currentUserId) {
                kycError.textContent = "User not authenticated. Please log in.";
                kycError.classList.remove('hidden');
                hideLoading();
                return;
            }

            // Get selected radio button value for sanctioned dealing
            const sanctionedDealingRadios = document.getElementsByName('sanctionedDealing');
            let sanctionedDealingValue = '';
            for (const radio of sanctionedDealingRadios) {
                if (radio.checked) {
                    sanctionedDealingValue = radio.value;
                    break;
                }
            }

            // Get selected radio button value for group affiliation
            const isGroupRadios = document.getElementsByName('isGroup');
            let isGroupValue = '';
            for (const radio of isGroupRadios) {
                if (radio.checked) {
                    isGroupValue = radio.value;
                    break;
                }
            }

            // Collect all form data (text fields)
            const tempFormData = {
                companyName: document.getElementById('companyName').value,
                legalEntityType: document.getElementById('legalEntityType').value,
                regNumber: document.getElementById('regNumber').value,
                dateOfIncorporation: document.getElementById('dateOfIncorporation').value,
                placeOfIncorporation: document.getElementById('placeOfIncorporation').value,
                taxIdNumber: document.getElementById('taxIdNumber').value,
                companyAddress: document.getElementById('companyAddress').value,
                websiteUrl: document.getElementById('websiteUrl').value,
                businessDescription: document.getElementById('businessDescription').value,
                commoditiesTraded: document.getElementById('commoditiesTraded').value,
                tonnageTraded: document.getElementById('tonnageTraded').value,
                annualTurnover: document.getElementById('annualTurnover').value,
                countriesOfOperation: document.getElementById('countriesOfOperation').value,
                sanctionedDealing: sanctionedDealingValue,
                isGroup: isGroupValue,
                groupName: isGroupValue === 'Yes' ? groupNameInput.value : '',
                otherRelatedEntities: isGroupValue === 'Yes' ? otherRelatedEntitiesTextarea.value : '',
                
                // Key Position Holders
                ceoName: ceoNameInput.value,
                ceoEmail: ceoEmailInput.value,
                ceoPhone: ceoPhoneInput.value,
                cfoName: cfoNameInput.value,
                cfoEmail: cfoEmailInput.value,
                cfoPhone: cfoPhoneInput.value,
                otherKeyName: otherKeyNameInput.value,
                otherKeyPosition: otherKeyPositionInput.value,
                otherKeyEmail: otherKeyEmailInput.value,
                otherKeyPhone: otherKeyPhoneInput.value,

                contactPerson: document.getElementById('contactPerson').value,
                contactPersonPosition: document.getElementById('contactPersonPosition').value,
                contactEmail: document.getElementById('contactEmail').value,
                contactPhone: document.getElementById('contactPhone').value,
                bankName: document.getElementById('bankName').value,
                bankAccountNumber: document.getElementById('bankAccountNumber').value,
                swiftBic: document.getElementById('swiftBic').value,
                dataAccuracyConsent: dataAccuracyConsentCheckbox.checked,
                complianceUndertaking: complianceUndertakingCheckbox.checked,
                // uploadedFileUrls will be populated after uploads
            };

            // Apply sanitization and validation to relevant text fields
            const fieldsToSanitize = {
                'Company Name': tempFormData.companyName,
                'Registration Number': tempFormData.regNumber,
                'Place of Incorporation': tempFormData.placeOfIncorporation,
                'Tax Identification Number': tempFormData.taxIdNumber,
                'Company Address': tempFormData.companyAddress,
                'Business Description': tempFormData.businessDescription,
                'Types of Commodities Traded': tempFormData.commoditiesTraded,
                'Countries of Operation': tempFormData.countriesOfOperation,
                'Group Name': tempFormData.groupName,
                'Other Related Entities': tempFormData.otherRelatedEntities,
                'CEO Name': tempFormData.ceoName,
                'CFO Name': tempFormData.cfoName,
                'Other Key Name': tempFormData.otherKeyName,
                'Other Key Position': tempFormData.otherKeyPosition,
                'Bank Name': tempFormData.bankName,
                'Bank Account Number': tempFormData.bankAccountNumber,
                'SWIFT/BIC Code': tempFormData.swiftBic,
                'Contact Person Name': tempFormData.contactPerson,
                'Contact Person Position': tempFormData.contactPersonPosition
            };

            for (const fieldName in fieldsToSanitize) {
                if (!sanitizeAndValidateInput(fieldsToSanitize[fieldName], fieldName)) {
                    hideLoading();
                    return; // Stop submission if validation fails
                }
            }

            // Specific validation for the three required fields
            if (tempFormData.companyName.trim() === '') {
                kycError.textContent = "Company Name is required.";
                kycError.classList.remove('hidden');
                hideLoading();
                return;
            }
            if (tempFormData.contactEmail.trim() === '') {
                kycError.textContent = "Contact Email is required.";
                kycError.classList.remove('hidden');
                hideLoading();
                return;
            }
            if (tempFormData.contactPhone.trim() === '') {
                kycError.textContent = "Contact Phone Number is required.";
                kycError.classList.remove('hidden');
                hideLoading();
                return;
            }

            // Add conditional validation for group details (still required if 'Yes' is selected)
            if (tempFormData.isGroup === 'Yes') {
                if (tempFormData.groupName.trim() === '') {
                    kycError.textContent = "Please enter the Group Name.";
                    kycError.classList.remove('hidden');
                    hideLoading();
                    return;
                }
                if (tempFormData.otherRelatedEntities.trim() === '') {
                    kycError.textContent = "Please enter Other Related Entities or 'None' if not applicable.";
                    kycError.classList.remove('hidden');
                    hideLoading();
                    return;
                }
            }

            try {
                // First, create the Firestore document to get its ID
                // This ID will be used for structuring paths in Firebase Storage
                const docRef = await addDoc(collection(db, `kycigaptrading/${currentUserId}/kycApplications`), {
                    // Temporarily save data without file URLs, will update later
                    ...tempFormData,
                    submissionTimestamp: new Date().toISOString(), // Add submission timestamp
                    uploadedFileUrls: {} // Initialize as empty, will fill after uploads
                });
                const kycDocId = docRef.id;
                console.log("Firestore document created with ID:", kycDocId);

                const fileUploadPromises = [];
                const uploadedFileUrls = {}; // This will hold all URLs, including the generated PDF

                // 1. Upload user-provided attachments
                // Map of file inputs to their corresponding keys in uploadedFileUrls
                const fileInputs = [
                    { input: regCertificateFile, key: 'regCertificate' },
                    { input: taxIdFile, key: 'taxId' },
                    { input: bankStatementFile, key: 'bankStatement' },
                    { input: orgChartFile, key: 'orgChart' }
                ];

                for (const { input, key } of fileInputs) {
                    if (input.files.length > 0) {
                        fileUploadPromises.push(
                            uploadFile(input.files[0], input.files[0].name, currentUserId, kycDocId).then(url => {
                                if (url) uploadedFileUrls[key] = url;
                            })
                        );
                    }
                }

                // Handle multiple other documents
                if (otherDocsFile.files.length > 0) {
                    const otherDocUrls = [];
                    for (const file of otherDocsFile.files) {
                        fileUploadPromises.push(
                            uploadFile(file, file.name, currentUserId, kycDocId).then(url => {
                                if (url) otherDocUrls.push(url);
                            })
                        );
                    }
                    uploadedFileUrls['otherDocs'] = otherDocUrls;
                }

                // Wait for all user-provided file uploads to complete first
                await Promise.all(fileUploadPromises);

                // 2. Generate and upload the KYC Form Summary PDF
                const kycFormPdfBlob = await generateKycPdf(tempFormData, uploadedFileUrls);
                const kycFormPdfUrl = await uploadFile(kycFormPdfBlob, 'kyc_form_summary.pdf', currentUserId, kycDocId);
                if (kycFormPdfUrl) {
                    uploadedFileUrls['kycFormPdf'] = kycFormPdfUrl;
                }

                // 3. Update the Firestore document with ALL collected file URLs (including the generated PDF)
                await setDoc(doc(db, `kycigaptrading/${currentUserId}/kycApplications`, kycDocId), { uploadedFileUrls }, { merge: true });
                console.log("Firestore document updated with all file URLs, including generated PDF.");

                // Show the success modal
                showSuccessModal("Thank you for submitting KYC details, we will review the details and contact you.");
                
            } catch (error) {
                console.error("KYC submission error:", error);
                kycError.textContent = `Submission failed: ${error.message || "An unexpected error occurred."}`;
                kycError.classList.remove('hidden');
            } finally {
                hideLoading();
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            showLoading();
            try {
                await signOut(auth);
                console.log("User logged out.");
                // onAuthStateChanged will handle redirecting to login section and clearing fields
            } catch (error) {
                console.error("Logout error:", error);
                // Optionally display an error message for logout
            } finally {
                hideLoading();
            }
        });
    </script>
</body>
</html>





